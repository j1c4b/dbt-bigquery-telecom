version: 2

sources:
  - name: raw_telecom
    description: |
      **PHASE 1 VALIDATION SOURCE**
      Raw telecom operational data from source systems.
      Focus on basic structure validation and relationships.
    
    database: dbt-bigquery-telecom
    schema: telecom_raw_data
    
    tables:
      # =============================================
      # CUSTOMERS TABLE - Master customer data
      # =============================================
      - name: customers
        description: "Customer master data - foundation for all relationships"
        tests:
          - table_is_partitioned
        columns:
          - name: customer_id
            description: "Primary key - unique customer identifier"
            tests:
              - unique
              - not_null
              # Advanced statistical validation
              - dbt_expectations.expect_column_values_to_match_regex:
                  regex: '^CUST_[A-Z0-9]{3,10}$'
                  config:
                    severity: warn
                    tags: ['format_validation', 'advanced']
                  
          - name: email
            description: "Customer email - unique identifier for communication"
            tests:
              - unique
              - not_null
              # Advanced email validation
              - dbt_expectations.expect_column_values_to_match_regex:
                  regex: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
                  config:
                    severity: error
                    tags: ['format_validation', 'advanced']
              # Statistical validation - email domain distribution
              - dbt_expectations.expect_column_value_lengths_to_be_between:
                  min_value: 5
                  max_value: 100
                  config:
                    severity: warn
                    tags: ['statistical_validation', 'advanced']
                    
          - name: phone_number
            description: "Primary contact number"
            tests:
              - not_null
                    
          - name: registration_date
            description: "Customer registration date"
            tests:
              - not_null
                    
          - name: customer_status
            description: "Current customer status"
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: ['Active', 'Inactive', 'Churned', 'Unknown']
                    
          - name: updated_at
            description: "Record last update timestamp"
            tests:
              - not_null

      # =============================================
      # SUBSCRIPTIONS TABLE
      # =============================================
      - name: subscriptions
        description: "Customer subscription data"
        tests:
          - table_is_partitioned 'start_date'
        columns:
          - name: subscription_id
            description: "Primary key for subscription"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Foreign key to customers table"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: plan_id
            description: "Plan identifier"
            tests:
              - not_null
                    
          - name: start_date
            description: "Subscription start date"
            tests:
              - not_null
                    
          - name: monthly_fee
            description: "Monthly subscription fee"
            tests:
              - not_null
              # Telecom business rule: monthly fees between $5-$500
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 5.00
                  max_value: 500.00
                  config:
                    severity: error
                    tags: ['business_rule', 'telecom_specific', 'advanced']
              # Statistical validation: detect pricing anomalies  
              - dbt_expectations.expect_column_mean_to_be_between:
                  min_value: 20.00
                  max_value: 150.00
                  config:
                    severity: warn
                    tags: ['statistical_validation', 'pricing_anomaly', 'advanced']

      # =============================================
      # USAGE_RECORDS TABLE
      # =============================================
      - name: usage_records
        description: "Daily usage records - high volume table"
        tests:
          - table_is_partitioned 'usage_date'
        columns:
          - name: usage_id
            description: "Unique usage record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer identifier - must exist in customers"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: usage_date
            description: "Date of usage"
            tests:
              - not_null
              # Advanced date validation - no future dates
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: '2020-01-01'
                  max_value: '{{ run_started_at.strftime("%Y-%m-%d") }}'
                  config:
                    severity: error
                    tags: ['business_rule', 'temporal_validation', 'advanced']
              # Statistical validation - usage date distribution
              - dbt_expectations.expect_column_distinct_count_to_be_between:
                  min_value: 1
                  max_value: 365
                  config:
                    severity: warn
                    tags: ['statistical_validation', 'data_quality', 'advanced']

      # =============================================
      # BILLING TABLE
      # =============================================
      - name: billing
        description: "Monthly billing records"
        tests:
          - table_is_partitioned 'billing_month'
        columns:
          - name: bill_id
            description: "Unique billing record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer being billed"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: total_amount
            description: "Total bill amount"
            tests:
              - not_null
              # Telecom business rule: billing amounts validation
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 0
                  max_value: 10000
                  config:
                    severity: error
                    tags: ['business_rule', 'financial_validation', 'advanced']
              # Advanced statistical validation: detect billing anomalies
              - dbt_expectations.expect_column_quantile_values_to_be_between:
                  quantile: 0.95
                  min_value: 50
                  max_value: 500
                  config:
                    severity: warn
                    tags: ['statistical_validation', 'anomaly_detection', 'advanced']
              # Revenue integrity: no negative amounts
              - dbt_expectations.expect_column_min_to_be_between:
                  min_value: 0
                  max_value: 1000000
                  config:
                    severity: error
                    tags: ['financial_integrity', 'revenue_protection', 'advanced']

      # =============================================
      # NETWORK_QUALITY TABLE
      # =============================================
      - name: network_quality
        description: "Network performance data"
        tests:
          - table_is_partitioned 'recorded_at'
        columns:
          - name: quality_id
            description: "Unique quality record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer identifier"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: call_quality_score
            description: "Call quality score (1-5 scale)"
            tests:
              - not_null
              # Telecom business rule: quality scores 1-5 only
              - dbt_expectations.expect_column_values_to_be_between:
                  min_value: 1
                  max_value: 5
                  config:
                    severity: error
                    tags: ['business_rule', 'quality_assurance', 'advanced']
              # Advanced statistical validation: quality distribution analysis
              - dbt_expectations.expect_column_mean_to_be_between:
                  min_value: 2.0
                  max_value: 4.5
                  config:
                    severity: warn
                    tags: ['statistical_validation', 'network_performance', 'advanced']
              # Service level monitoring: detect quality degradation
              - dbt_expectations.expect_column_stdev_to_be_between:
                  min_value: 0.1
                  max_value: 2.0
                  config:
                    severity: warn
                    tags: ['service_monitoring', 'quality_variance', 'advanced']

      # =============================================
      # BILLING_TEST_FAIL TABLE - Intentional test failures
      # =============================================
      - name: billing_test_fail
        description: "Test table with intentional schema issues to validate dbt test failures"
        # NOTE: No table-level tests because this table is not partitioned
        columns:
          - name: bill_id
            description: "Unique billing record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer being billed"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: billing_month
            description: "INTENTIONAL ISSUE: This is STRING but should be DATE - expect type validation to fail"
            tests:
              - not_null
              # This test should FAIL because billing_month is STRING, not DATE
              - dbt_utils.expression_is_true:
                  expression: "billing_month RLIKE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'"
                  config:
                    severity: warn
                    tags: ['intentional_failure', 'data_type_test']
                    
          - name: total_amount
            description: "INTENTIONAL ISSUE: This is nullable but should be NOT NULL - expect not_null test to fail"
            tests:
              # This test should FAIL because total_amount has NULL values
              - not_null:
                  config:
                    severity: error
                    tags: ['intentional_failure', 'completeness_test']