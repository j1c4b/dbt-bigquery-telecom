version: 2

sources:
  - name: raw_telecom
    description: |
      **PHASE 1 VALIDATION SOURCE**
      Raw telecom operational data from source systems.
      Focus on basic structure validation and relationships.
    
    database: dbt-bigquery-telecom
    schema: telecom_raw_data
    
    tables:
      # =============================================
      # CUSTOMERS TABLE - Master customer data
      # =============================================
      - name: customers
        description: "Customer master data - foundation for all relationships"
        tests:
          - table_is_partitioned
        columns:
          - name: customer_id
            description: "Primary key - unique customer identifier"
            tests:
              - unique
              - not_null
                  
          - name: email
            description: "Customer email - unique identifier for communication"
            tests:
              - unique
              - not_null
                    
          - name: phone_number
            description: "Primary contact number"
            tests:
              - not_null
                    
          - name: registration_date
            description: "Customer registration date"
            tests:
              - not_null
                    
          - name: customer_status
            description: "Current customer status"
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: ['Active', 'Inactive', 'Churned', 'Unknown']
                    
          - name: updated_at
            description: "Record last update timestamp"
            tests:
              - not_null

      # =============================================
      # SUBSCRIPTIONS TABLE
      # =============================================
      - name: subscriptions
        description: "Customer subscription data"
        tests:
          - table_is_partitioned 'start_date'
        columns:
          - name: subscription_id
            description: "Primary key for subscription"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Foreign key to customers table"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: plan_id
            description: "Plan identifier"
            tests:
              - not_null
                    
          - name: start_date
            description: "Subscription start date"
            tests:
              - not_null
                    
          - name: monthly_fee
            description: "Monthly subscription fee"
            tests:
              - not_null

      # =============================================
      # USAGE_RECORDS TABLE
      # =============================================
      - name: usage_records
        description: "Daily usage records - high volume table"
        tests:
          - table_is_partitioned 'usage_date'
        columns:
          - name: usage_id
            description: "Unique usage record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer identifier - must exist in customers"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: usage_date
            description: "Date of usage"
            tests:
              - not_null

      # =============================================
      # BILLING TABLE
      # =============================================
      - name: billing
        description: "Monthly billing records"
        tests:
          - table_is_partitioned 'billing_month'
        columns:
          - name: bill_id
            description: "Unique billing record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer being billed"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: total_amount
            description: "Total bill amount"
            tests:
              - not_null

      # =============================================
      # NETWORK_QUALITY TABLE
      # =============================================
      - name: network_quality
        description: "Network performance data"
        tests:
          - table_is_partitioned 'recorded_at'
        columns:
          - name: quality_id
            description: "Unique quality record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer identifier"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: call_quality_score
            description: "Call quality score (1-5 scale)"
            tests:
              - not_null

      # =============================================
      # BILLING_TEST_FAIL TABLE - Intentional test failures
      # =============================================
      - name: billing_test_fail
        description: "Test table with intentional schema issues to validate dbt test failures"
        # NOTE: No table-level tests because this table is not partitioned
        columns:
          - name: bill_id
            description: "Unique billing record identifier"
            tests:
              - unique
              - not_null
                    
          - name: customer_id
            description: "Customer being billed"
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw_telecom', 'customers')
                    field: customer_id
                    
          - name: billing_month
            description: "INTENTIONAL ISSUE: This is STRING but should be DATE - expect type validation to fail"
            tests:
              - not_null
              # This test should FAIL because billing_month is STRING, not DATE
              - dbt_utils.expression_is_true:
                  expression: "billing_month RLIKE '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'"
                  config:
                    severity: warn
                    tags: ['intentional_failure', 'data_type_test']
                    
          - name: total_amount
            description: "INTENTIONAL ISSUE: This is nullable but should be NOT NULL - expect not_null test to fail"
            tests:
              # This test should FAIL because total_amount has NULL values
              - not_null:
                  config:
                    severity: error
                    tags: ['intentional_failure', 'completeness_test']